'use strict';var express=require('express'),bodyParser=require('body-parser'),request=require('request'),app=express(),Recommendations=require('./recommendations.js'),ACCESS_TOKEN=process.env.FB_PAGE_ACCESS_TOKEN,REQUEST_URI='https://graph.facebook.com/v2.6/me/messages';app.set('port',process.env.PORT||5e3),app.use(bodyParser.urlencoded({extended:!1})),app.use(bodyParser.json()),app.get('/',function(a,b){b.send('Welcome to the land of sizzling sausages.')}),app.post('/webhook/',function(a,b){var c=a.body;'page'==c.object&&c.entry.forEach(function(d){var e=d.id,f=d.time;d.messaging.forEach(function(g){g.message?receivedMessage(g):g.postback&&receivedPostback(g)})}),b.sendStatus(200)});function receivedMessage(a){var b=a.sender.id,c=a.recipient.id,d=a.timestamp,e=a.message;console.log('Received message for user %d and page %d at %d with message:',b,c,d),console.log(JSON.stringify(e));var f=Recommendations.randomRestaurant();callSendAPI(getMessageTemplate(b,f))}function receivedPostback(){console.log('postback not yet implemented')}function getMessageTemplate(a,b){return{recipient:{id:a},message:{attachment:{type:'template',payload:{template_type:'generic',elements:[{title:b.title,image_url:b.imageUrl,subtitle:b.location,default_action:{type:'web_url',url:b.yelpUrl,messenger_extensions:!0,webview_height_ratio:'tall'},buttons:[{type:'web_url',title:'View on Yelp',url:b.yelpUrl},{type:'web_url',title:'Directions',url:b.mapsUrl}]}]}}}}}function callSendAPI(a){console.log('sending request',a),request({uri:REQUEST_URI,qs:{access_token:ACCESS_TOKEN},method:'POST',json:a},function(b,c,d){if(!b&&200==c.statusCode){var e=d.recipient_id,f=d.message_id;f?console.log('Successfully sent message with id %s to recipient %s',f,e):console.log('Successfully called Send API for recipient %s',e)}else console.error('Failed calling Send API',c.statusCode,c.statusMessage,d.error)})}app.listen(app.get('port'),function(){console.log('running on port',app.get('port'))});